---
title: "Combined"
output: html_document
date: "February 16, 2016"
geometry: margin=2cm
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

# Import Data
library(plotly)
library(ggplot2)
library(package = "lattice")
library(ggmap)
library(source.gist)
library(rworldmap)
library("Hmisc")
library(base)
library(scales)
library(chron)
library(RColorBrewer)

setwd('~/Desktop/qmss/spring2016/stat4701/Edav-project-2')

dat <- read.csv ("./data/cleanGlobalFloodDataWithRegionsGDP.csv",header=TRUE, stringsAsFactors=FALSE, fileEncoding="latin1")
datc <- dat
floods <- read.csv('./data/cleanGlobalFloodDataWithRegions.csv')

Dev = read.csv("./data/2015_development index.csv")
#View(Dev)
flood2 <- read.csv("./data/cleanGlobalFloodDataWithRegionsfiltered-Index noNA.csv")
#View(flood2)

## Adding a year column
#date1<- as.Date(flood$dateBegan,"%m/%d/%Y")
#flood$year<-as.numeric(format(date1, "%Y"))

## Add other to mainCause1

flood2$GNIPerCapita <- as.numeric(flood2$GNIPerCapita)
flood2$peopleDisplaced <- as.numeric(flood2$peopleDisplaced)
flood2$HDIclass <- cut(flood2$HDI,
                     breaks=c(-Inf, 0.6, 0.75, Inf),
                     labels=c("low","medium","high"))
#summary(flood2$HDIclass)
#plot(flood2$HDIclass)
```


## Part 1 - Understanding the Flood Data: Where Do Floods Happen and Why
What is the typical size of a flood? Does this change by cause, location, or some other factor? 

```{r}
library(ggplot2)
ggplot(floods, aes(affectedSqKm)) +
  geom_histogram(bins=100)

```


What is the typical duration of the flood?

```{r}
library(ggplot2)
ggplot(floods, aes(durationDays)) +
  geom_histogram(bins=100)

```

How are floods distributed in space?

```{r}
library(ggplot2)

mapWorld <- borders("world", colour="gray50")
m <- ggplot(floods) + mapWorld
m <- m + geom_point(aes(x=centroidX, 
                        y=centroidY,
                        color='blue'),
                    alpha=.5, size=1)
```



```{r floods}
library(ggplot2)

primaryCauses <- floods[floods$mainCause1 %in% c("Heavy Rain", "Monsoon", "Hurricane/Tropical Storm", "Snow/Ice Melt"),]

mapWorld <- borders("world", colour="gray50")
m <- ggplot(primaryCauses) + mapWorld
m <- m + geom_point(aes(x=centroidX, 
                        y=centroidY,
                        color=mainCause1),
                    alpha=.5, size=1)
m + facet_wrap(facets= ~mainCause1, ncol=2)

```

Heavy Rain Density

```{r}
m1 <- NULL
mapWorld <- borders("world", colour="gray50")
m1 <- ggplot() + mapWorld
m1 + stat_density2d(aes(x=centroidX, y=centroidY, fill=..level.., alpha = ..level..), 
                    size=.5, data=floods[floods$mainCause1=='Heavy Rain',], geom="polygon")
```

Monsoon Density

```{r}
m2 <- NULL
mapWorld <- borders("world", colour="gray50", ylim = c(-15, 35), xlim = c(67,110))
m2 <- ggplot() + mapWorld
m2 + stat_density2d(aes(x=centroidX, y=centroidY, fill=..level.., alpha = ..level..), 
                    size=.5, geom="polygon", 
                    data=floods[floods$mainCause1=='Monsoon',])
```


# Part 2 - Flood Impact and Economic Development

```{r}

########################################################################
#### AREA AFFECTED
# Let's see how the distribution of affected sqkm range. 
areaInterval <- cut2(datc$affectedSqKm, c(10000,50000,100000,10000000))

# Let's divide affected area into small, medium, large, or very large intervals. 
datc$affected <- ifelse(datc$affectedSqKm < 10000, "Small", ifelse(datc$affectedSqKm < 50000, "Medium", ifelse(datc$affectedSqKm < 100000, "Large", "Very Large")))
datc$affected = factor(datc$affected,levels=c("Small", "Medium", "Large", "Very Large"), ordered = TRUE) 
########################################################################
#### People Dead
deadInterval <- cut2(datc$peopleDead, c(10,50,100,10000000))

# Let's divide people dead into intervals
datc$dead <- ifelse(datc$peopleDead < 10, "Under 10", ifelse(datc$peopleDead < 50, "10-50", ifelse(datc$peopleDead < 100, "50-100", "Over 100")))
datc$dead = factor(datc$dead,levels=c("Under 10", "10-50","50-100","Over 100"), ordered = TRUE) 

########################################################################
#### People displaced
displacedInterval <- cut2(datc$peopleDisplaced, c(30,5000,100000,100000000))

# Let's divide people displaced into intervals
datc$displaced <- ifelse(datc$peopleDisplaced < 30, "Under 30", ifelse(datc$peopleDisplaced < 5000, "30-5000", ifelse(datc$peopleDisplaced < 100000, "5000-100000", "Over 100000")))
datc$displaced = factor(datc$displaced,levels=c("Under 30", "30-5000","5000-100000","Over 100000"), ordered = TRUE) 

########################################################################
#### Duration
durationInterval <- cut2(datc$durationDays, c(5, 10, 20, 500))

# Let's divide duration into intervals
datc$duration <- ifelse(datc$durationDays < 5, "Under 5", ifelse(datc$durationDays < 10, "5-10", ifelse(datc$durationDays < 20, "10-20", "Over 20")))
datc$duration = factor(datc$duration,levels=c("Under 5", "5-10","10-20","Over 20"), ordered = TRUE) 

#########################################################################
datc$incomeGroup <- datc$Income.Group.OECD
datc$incomeGroup = factor(datc$incomeGroup, levels = c("Low income", "Lower middle income", "Upper middle income","High income: nonOECD", "High income: OECD"), ordered = TRUE)

datc$GDPlevel <- ifelse(datc$Income.Group.OECD == "High income: OECD", 5, 
                        ifelse(datc$Income.Group.OECD == "High income: nonOECD", 4,
                               ifelse(datc$Income.Group.OECD == "Upper middle income", 3,
                                      ifelse(datc$Income.Group.OECD == "Lower middle income", 2, 1))))

```


```{r, echo = FALSE}
#bwplot(~datc$incomeGroup|factor(datc$sub_region),
#       xlab="Subregions", 
#       ylab="Income Group Distribution", 
#       scales = list(x = list(labels = c("a", "Low Income", "Lower Middle Income", "Upper Middle Income", "High Income","High Income OECD")), rot = 90),
#       data=datc,
#       main="Income group Distributionse of Countries in Each Subregion")
```

Different region groups have countries of varying income levels. 

#Magnitude and Displacement/Death

```{r, echo = FALSE}
# People displacement and country income group. 
dotplot(datc$peopleDisplaced ~ datc$magnitude | datc$incomeGroup,
       xlab="Magnitude", 
       ylab="People Displaced", 
       main="Displacement by Magnitude Grouped by Income Level",
       scales=list(y=list(draw = FALSE)),
       data = datc)

dotplot(datc$peopleDead ~ datc$magnitude | datc$incomeGroup,
       xlab="Magnitude", 
       ylab="People Dead", 
       main="Death by Magnitude Grouped by Income Level",
       scales=list(y=list(draw = FALSE)),
       data = datc)


library(nlme) 
```
#Displacement

The scatterplot of people displaced for high income is concentrated in the bottom, which means that High Income countries tend to not displace people much regardless of the magnitude of the flood. 

In contrast, low income, lower middle income, and upper middle income countries seem to be more middle-heavy. 
These countries also seem to displace more people as magnitude increases. 

#Deaths
The scatterplot of people dead for high income is very bottom-heavy, even more so than in displacement. 
As income level goes down, we notice that a lot more points are plotted on top. 
We can quantify this finding further by running a regression analysis by country income level. 


```{r}
lmList(peopleDisplaced ~ magnitude | incomeGroup, data = datc, na.action = na.omit)
lmList(peopleDead ~ magnitude | incomeGroup, data = datc, na.action = na.omit)

```

#Displacement
There is a trend of the slope coefficient on the variable "magnitude" as income level goes down. 
This means that the higher the magnitude, the higher number of people are displaced as country income level goes down. 
Intuitively, this can be interepreted as since high-income countries are better prepared for floods in all magnitude, they tend to displace only few people regardless of magnitude. 
However, countries with low income do not have resources to prepare for floods with large magnitude. 
Therefore, they tend to displace more people as magnitude intensifies. 

#Death
Similarly, the coefficient on magnitude to predict number of death is not even positive for high income OECD countries. However, as the income level goes down, the importance of magnitude in predicting the number of deaths increases. The reasoning is the same as displacement. Countries with high income are better prepared, and they take good measures to prevent deaths from happeneing, even in cases of severe magnitudes. Countries with lower incomes do not have such resources. 

Now, let's look at differing effects of affected area by country income group. 

#Size of Affected Area and Displacement/Death
```{r echo = FALSE}
dotplot(datc$displaced ~ datc$affectedSqKm | datc$sub_region,
       xlab="Size of Affected Area", 
       ylab="People Displaced", 
       main="Displacement by Size of Affected Area Grouped by Income Level",
       data = datc)
dotplot(datc$dead ~ datc$affectedSqKm | datc$incomeGroup, 
       xlab="Size of Affected Area", 
       ylab="Deaths", 
       main="Deaths by Size of Affected Area Grouped by Income Level",
       data = datc)

```

#Displacement
Similar to magnitude, in High Income OECD countreis, the scatterplot is bottom-heavy. Regardless of the size of the affected area, very few people were displaced. However for Lower middle income and upper middle income countries, the scatterplot is top-heavy, which means that the larger the affected area, the more people were displaced. 

#Death
The correlation between number of people dead and the area of affected region seems to be lower for deaths. Again, for High-OECD countries, the scatterplot is very much bottom-heavy. 

```{r}
lmList(peopleDisplaced ~ affectedSqKm | incomeGroup, data = datc, na.action = na.omit)
lmList(peopleDead ~ affectedSqKm | incomeGroup, data = datc, na.action = na.omit)
```

The regression analysis indicates that similar trend of strong correlation beween area affected and number of people displaced as the country income level goes down. 

The relationship between the size of area affected and number of deaths seems to be much weaker. 
Interestingly, high income OECD countries and upper middle income countries have a negative relationship between affected square kilometers and number of deaths. While the coefficient is not very large, this can mean that when there are floods that affect large areas, countries predict it and take measures to prevent deaths. 

More detailed data can be found when countries are analyzed at a subregion level. 

Size of Affected Area 

```{r, echo = FALSE}
dotplot(datc$displaced ~ datc$affectedSqKm | datc$sub_region,
       xlab="Size of Affected Area", 
       ylab="People Displaced", 
       main="Displacement by Size of Affected Area Grouped by Region",
       data = datc)

dotplot(datc$dead ~ datc$affectedSqKm | datc$sub_region, 
       xlab="Size of Affected Area", 
       ylab="People Dead", 
       main="Death by Size of Affected Area Grouped by Region",
       data = datc)
```

Subregions that displaced more people as the size of affected region increased were South America, Eastern Asia, and Southern Asia. 
Subregions that displaced very few people regardless of the size of the affected area were western Asia and Austria and New Zealand. 

Subregions that experienced more deaths as the size of affected region increased were Southern Asia and Eastern Asia
Subregions that experienced few deaths regardless of the size of the affected area were Western Asia and Austria/New Zealand. 

#Magnitudes by Floods of Different Causes

```{r, echo = FALSE}

bwplot(~datc$magnitude|factor(datc$mainCause1),data=datc,col="blue",
       xlab = "Magnitude",
       main="Magnitude of Floods Caused by Different Main Causes")
```

While Landslides and Avalanches seem to cause floods only between magnitudes of 4 and 5, Heavy rain seems to cause floods of varying degrees of magnitudes. 


#Size of Affected Areas by Floods of Different Causes

```{r, echo = FALSE}
bwplot(~datc$affected|factor(datc$mainCause1),data=datc,col="blue",
       xlab = "Size of Area Affected",
       main="Size of Area Affected by Different Main Causes")
```

Snow/Ice Melt and Tsunami can affect a wide array of sizes of lands. 
Landslides/Avalanches seem to usually affect small areas, and Monsoons seem to affect large areas. 


```{r, echo = FALSE}
bwplot(~datc$displaced|factor(datc$mainCause1),data=datc,col="blue",
       xlab = "Number of Displacements",
       main="Number of Displaced People by Main Causes")

bwplot(~datc$dead|factor(datc$mainCause1),data=datc,col="blue",
       xlab = "Number of Deaths",
       main="Number of Deaths by Main Causes")
```

Monsoons and Hurricanes/Tropical Storm seem to displace many people while Landslides/avalanches and snow/ice melt seem to usually displace fewer people. 
Tsunamis always seem to kill many people, while snow/ice melt seems to always kill only few people. 

#Damage Caused by Floods 
```{r, echo = FALSE}
dotplot(datc$damageUsd ~ datc$affectedSqKm | datc$sub_region, 
       xlab="Size of Affected Area", 
       ylab="Damage USD", 
       main="Damage USD by Size of Affected Area Grouped by Region",
       scales=list(y=list(draw = FALSE)),
       data = datc)
```

Northern America and Northern Europe seem to have very high starting point of damage in USD probably because since the GDP is high, when damage is done, it is more expensive to recover from the damage. Middle Africa seems to have the lowest starting point in terms of damage in USD. 

```{r, echo = FALSE}
hist <- ggplot(datc, aes(x = datc$sub_region, fill = datc$mainCause1))
hist + geom_bar(color = "black", aes(fill = datc$mainCause1, position = "fill"))+
  labs(title = "Main Causes by Region", x = "Region", y = "Percent") + 
  scale_fill_discrete(name="Main Causes") + guides(fill = guide_legend(reverse=TRUE))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

South-Eastern Asia, followed by Southern Asia and then Eastern Asia and Northen America, experience the most number of floods. For each region, over 50% or more floods are caused by heavy rain. In the case of Southern Asia, a large portion of floods are caused by Monsoon. Hurricane/Tropical Storms seem to happen quite often in South-Eastern Asia and Eastern Asia. 



# Part 4 - Understanding the impact of flood

Flood have a huge impact on population and economy.
Heavy rain leads to destructionsm, death, displacement, healness, reparations.
Some countries may receive more floods based on its location (for example India) but some countries also don't have the capacity to prevent, prepare population, manage flood and repare.

In this analysis we will try to analyse what characteristic influence the impact of a flood.

## Impact evolution

Let's first take a look at the evolution of flood in time

```{r, echo=FALSE}
#PLOT
## Severity by year:
ggplot(data = flood2, aes(year, magnitude, fill=severity)) +
  stat_summary(fun.y = "mean", geom = "bar")  # or "line" 

## Graph by cause
#ggplot(data = flood2, aes(year, magnitude, fill=mainCause1)) +
#  stat_summary(fun.y = "sum", geom = "bar")  # or "line" 

## Graph by cause except Heavy rain
#ggplot(subset(flood2, mainCause1 != "Heavy Rain")) +
#  aes(year, magnitude, fill=mainCause1) +
#  stat_summary(fun.y = "sum", geom = "bar")
```

We note that there is an augmentation of the severity of flood in the last decade. But there is no specific cause that can explain it.

```{r, echo=FALSE}
## Type of flood by continent
ggplot(subset(flood2)) +
  aes(year, magnitude, fill=mainCause1) +
  stat_summary(fun.y = "sum", geom = "bar") +
  facet_wrap(~sub_region, ncol = 4)
```

When we analyze the repartion of floods by region, we note that there are some region more affected and that some region are more targeted by specific type of disaster.
For example:

 + Eastern Europe and North American are more touched by Ice Melt
 + Southern Asia is highly affected by Monsoon.
 + Central America is mainly touched by hurricane.
  

# Impact on population
```{r, echo=FALSE}
# Multiple plot function
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

## Type of flood by continent
p1 <- ggplot(subset(flood2)) +
  aes(year, peopleDead, fill=mainCause1) +
  stat_summary(fun.y = "sum", geom = "bar") 

p2 <- ggplot(subset(flood2)) +
  aes(year, peopleDisplaced, fill=mainCause1) +
  stat_summary(fun.y = "sum", geom = "bar")+
   guides(fill = FALSE)

multiplot(p1, p2, cols=2)
```

Based on these 2 graphs, we note 2 things:

 + Some floods have terrible impact on human lives. For example, in Thailand, in 2004 when 160,000 people died in a tsunami. Therefore, we assume that the number of dead is not linked to the characteristic of the country.
 + When we look at the number of people displaced, we see a very different patern. It is quite stable and the main event that push people to move is Monsoon. Furthermore, we know that monsoon tend to happend in a very specific region of the world, mainly south east Asia.
 

## Characteristics of country and floods' impact

In what type of countries does flood have a greater impact on population?
To answer this question we will gather and merge data about Human development index (HDI), life expectancy, expected number of school year, Gross National Income (GNI) per capita.

```{r, echo=FALSE}
## People displaced/magnitude of flood by year, HDIclass and sub-continent
ggplot(subset(flood2, mainCause1 = "Dam failure")) +
  aes(year, peopleDisplaced, fill= HDIclass) +
  stat_summary(fun.y = "sum", geom = "bar") +
  facet_wrap(~region, ncol = 3)
```

When we look at people displaced, we see that it mainly affect Asian and African countries and mainly countries with low (below 0.6) or medium (between 0.6 and 0.75) HDI.

## Regression Model



```{r, echo=FALSE}
summary(lm(peopleDead ~ HDI + lifeExp+ GNIPerCapita, data = flood2))$coefficients


```

The regression analysis confirm that country characteristics does not impact the number of dead people per flood. 


```{r, echo=FALSE}
fit1 =  lm(peopleDisplaced ~ HDI + lifeExp+ GNIPerCapita, data = flood2)
summary(fit1)
```

There is a true correlation between the stage of development of a country and the number of displaced people during floods.

## Main finding

When it comes to death toll, no country is protected against a huge event as a huge tsunami or a hurricane. But facing heavy rain, developed country have better infrastructure and a greater capacity to take care of the people touched by such event. They also have the ability to quickly repair in order to make the population suffer a minimum time so that they don't have to move.




